name: Deploy Frontend to Azure

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'Frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  FRONTEND_PATH: 'Frontend'

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create .env.production in Frontend
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          cat > .env << 'EOF'
          # Production Environment for AudiSoft Frontend
          API_BASE_URL_PRODUCTION=${{ secrets.FRONTEND_API_BASE_URL }}
          API_BASE_URL_DEVELOPMENT=http://localhost:5281/api/v1
          NODE_ENV=production
          DEBUG_MODE=false
          API_TIMEOUT=30000
          API_RETRY_ATTEMPTS=3
          API_RETRY_DELAY=1000
          AUTH_TOKEN_KEY=audisoft_token
          AUTH_USER_KEY=audisoft_user
          AUTH_REFRESH_TOKEN_KEY=audisoft_refresh_token
          AUTH_TOKEN_EXPIRY_BUFFER=300000
          PAGINATION_DEFAULT_PAGE_SIZE=20
          PAGINATION_MAX_PAGE_SIZE=100
          PAGINATION_PAGE_SIZES=10,20,50,100
          UI_TOAST_DURATION=5000
          UI_LOADING_DELAY=300
          UI_DEBOUNCE_DELAY=300
          APP_NAME=AudiSoft School
          APP_VERSION=1.0.0
          APP_DESCRIPTION=Sistema de Gestión Escolar
          LOG_LEVEL=info
          EOF

      - name: Install dependencies
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm install

      - name: Build (prepare static files)
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          # No need to create public folder - server serves from root
          echo "✅ Frontend ready for deployment"

      - name: Verify server.js exists
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          if [ ! -f "server.js" ]; then
            echo "❌ server.js not found!"
            exit 1
          fi
          echo "✅ server.js found"
          head -5 server.js

      - name: Create package.json if not exists
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          if [ ! -f "package.json" ]; then
            cat > package.json << 'EOF'
          {
            "name": "audisoft-school-frontend",
            "version": "1.0.0",
            "description": "AudiSoft School - Sistema de Gestión Escolar",
            "main": "server.js",
            "scripts": {
              "start": "node server.js",
              "dev": "node server.js"
            },
            "dependencies": {
              "express": "^4.18.2",
              "dotenv": "^16.3.1"
            },
            "engines": {
              "node": ">=20.0.0"
            }
          }
          EOF
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.FRONTEND_PATH }}
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_FRONTEND_APP_NAME }}
          package: ./frontend
          resource-group: ${{ secrets.AZURE_FRONTEND_RESOURCE_GROUP }}

      - name: Logout from Azure
        run: az logout
        if: always()

      - name: Notify Deployment Success
        if: success()
        run: echo "✅ Frontend deployed successfully to ${{ secrets.AZURE_FRONTEND_APP_NAME }}"

      - name: Notify Deployment Failure
        if: failure()
        run: echo "❌ Frontend deployment failed"
